<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nirobo ‚Äî Admin Analytics Dashboard</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #004d00, #006400);
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 2px solid #d40000;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: rgba(0, 0, 0, 0.3);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid rgba(212, 0, 0, 0.3);
    }

    .stat-card h2 {
      color: #ffcccc;
      margin-bottom: 20px;
      font-size: 1.4rem;
      border-bottom: 1px solid #d40000;
      padding-bottom: 10px;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ff9999;
      margin: 15px 0;
    }

    .chart-container {
      height: 300px;
      margin: 20px 0;
    }

    .time-filter-btn {
      background: #006400;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .time-filter-btn:hover {
      background: #008000;
    }

    .time-filter-btn.active {
      background: #d40000;
      color: white;
    }

    .popular-searches, .popular-urls {
      background: rgba(0, 0, 0, 0.3);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 40px;
      border: 1px solid rgba(212, 0, 0, 0.3);
    }

    .popular-searches h2, .popular-urls h2 {
      color: #ffcccc;
      margin-bottom: 20px;
      font-size: 1.4rem;
      border-bottom: 1px solid #d40000;
      padding-bottom: 10px;
    }

    .search-item, .url-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-term, .url-title {
      font-weight: bold;
    }

    .search-count, .url-views {
      color: #ff9999;
      font-weight: bold;
    }

    footer {
      background-color: #1a1a1a;
      color: #ccc;
      padding: 20px;
      text-align: center;
      font-size: 0.9rem;
      border-top: 1px solid #333;
      margin-top: 40px;
    }

    footer a {
      color: #ff9999;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä NIROBO ADMIN ANALYTICS DASHBOARD</h1>
      <p>‚ÄúData is the silent voice of your audience ‚Äî listen carefully.‚Äù</p>
    </header>

    <!-- Admin Check -->
    <div id="adminCheck" style="text-align: center; padding: 50px;">
      <p>Checking admin access...</p>
    </div>

    <!-- Main Content (Hidden until admin verified) -->
    <div id="mainContent" style="display: none;">
      <!-- Time Filter Buttons -->
      <div style="text-align: center; margin: 20px 0;">
        <button class="time-filter-btn active" data-range="24h">Last 24 Hours</button>
        <button class="time-filter-btn" data-range="7d">Last 7 Days</button>
        <button class="time-filter-btn" data-range="30d">Last 30 Days</button>
        <button class="time-filter-btn" data-range="3m">Last 3 Months</button>
        <button class="time-filter-btn" data-range="6m">Last 6 Months</button>
        <button class="time-filter-btn" data-range="12m">Last 12 Months</button>
        <button class="time-filter-btn" data-range="all">Everything</button>
      </div>

      <!-- Views Over Time Chart -->
      <div class="stat-card">
        <h2>üìà Views Over Time</h2>
        <div class="chart-container">
          <canvas id="viewsChart"></canvas>
        </div>
      </div>

      <!-- Summary Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h2>üìà Total Pageviews</h2>
          <div class="stat-number" id="totalPageviews">0</div>
          <p>Across all pages</p>
        </div>

        <div class="stat-card">
          <h2>üë• Unique Visitors</h2>
          <div class="stat-number" id="uniqueVisitors">0</div>
          <p>Individual users</p>
        </div>

        <div class="stat-card">
          <h2>üåç Top Country</h2>
          <div class="stat-number" id="topCountry">-</div>
          <p>Most visits from</p>
        </div>

        <div class="stat-card">
          <h2>üì± Top Browser</h2>
          <div class="stat-number" id="topBrowser">-</div>
          <p>Most used browser</p>
        </div>
      </div>

      <!-- Additional Charts -->
      <div class="stats-grid">
        <div class="stat-card">
          <h2>üîó Top Referrers</h2>
          <div class="chart-container">
            <canvas id="referrerChart"></canvas>
          </div>
        </div>

        <div class="stat-card">
          <h2>üíª Top Browsers</h2>
          <div class="chart-container">
            <canvas id="browserChart"></canvas>
          </div>
        </div>

        <div class="stat-card">
          <h2>üì≤ Operating Systems</h2>
          <div class="chart-container">
            <canvas id="osChart"></canvas>
          </div>
        </div>

        <div class="stat-card">
          <h2>üåê Top Countries</h2>
          <div class="chart-container">
            <canvas id="countryChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Popular Searches -->
      <div class="popular-searches">
        <h2>üî• Popular Search Terms</h2>
        <div id="popularSearchesList">
          <p>No search data yet.</p>
        </div>
      </div>

      <!-- Popular URLs -->
      <div class="popular-urls">
        <h2>üöÄ Popular Submitted URLs</h2>
        <div id="popularUrlsList">
          <p>No URL view data yet.</p>
        </div>
      </div>
    </div>

    <footer>
      Made in Bangladesh üáßüá© | Curated by Nirobo<br>
      Honoring the Language Movement and the Silent Legacy of Justice<br>
      Crafted by KH. AL SHAIF ‚Äî for truth, clarity, and cultural dignity<br>
      <a href="admin.html">‚Üê Back to Admin Panel</a>
    </footer>
  </div>

  <script>
    // Check if user is admin
    function checkAdminAccess() {
      const adminPass = localStorage.getItem('niroboAdminPass');
      if (adminPass === 'nirobo') {
        document.getElementById('adminCheck').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        loadAnalytics();
      } else {
        alert('‚õî Admin access required. Please log in via admin panel.');
        window.location.href = 'admin.html';
      }
    }

    // Load analytics data
    function loadAnalytics() {
      const visits = JSON.parse(localStorage.getItem('niroboVisits') || '[]');
      const allSubmissions = JSON.parse(localStorage.getItem('niroboAllSubmissions') || '[]');

      // Summary Stats
      document.getElementById('totalPageviews').textContent = visits.length;
      
      const uniqueVisitors = new Set(visits.map(v => v.visitorId)).size;
      document.getElementById('uniqueVisitors').textContent = uniqueVisitors;

      // Top Country
      const countryStats = {};
      visits.forEach(v => {
        countryStats[v.country] = (countryStats[v.country] || 0) + 1;
      });
      const topCountry = Object.entries(countryStats).sort((a,b) => b[1] - a[1])[0];
      if (topCountry) {
        document.getElementById('topCountry').textContent = `${topCountry[0]} (${topCountry[1]})`;
      }

      // Top Browser
      const browserStats = {};
      visits.forEach(v => {
        browserStats[v.browser] = (browserStats[v.browser] || 0) + 1;
      });
      const topBrowser = Object.entries(browserStats).sort((a,b) => b[1] - a[1])[0];
      if (topBrowser) {
        document.getElementById('topBrowser').textContent = `${topBrowser[0]} (${topBrowser[1]})`;
      }

      // Create charts
      createViewsChart(visits);
      createReferrerChart(visits);
      createBrowserChart(visits);
      createOSChart(visits);
      createCountryChart(visits);

      // Popular Searches
      const searchTerms = {};
      visits.forEach(v => {
        if (v.url.includes('search.html?q=')) {
          const url = new URL(v.url);
          const q = url.searchParams.get('q');
          if (q) {
            searchTerms[q] = (searchTerms[q] || 0) + 1;
          }
        }
      });

      const popularSearchesList = document.getElementById('popularSearchesList');
      if (Object.keys(searchTerms).length === 0) {
        popularSearchesList.innerHTML = '<p>No search data yet.</p>';
      } else {
        popularSearchesList.innerHTML = '';
        Object.entries(searchTerms)
          .sort((a,b) => b[1] - a[1])
          .slice(0, 10)
          .forEach(([term, count]) => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.innerHTML = `
              <span class="search-term">${term}</span>
              <span class="search-count">${count} views</span>
            `;
            popularSearchesList.appendChild(div);
          });
      }

      // Popular URLs
      const popularUrlsList = document.getElementById('popularUrlsList');
      if (allSubmissions.length === 0) {
        popularUrlsList.innerHTML = '<p>No URL view data yet.</p>';
      } else {
        const sortedUrls = allSubmissions
          .filter(sub => sub.viewCount > 0)
          .sort((a,b) => (b.viewCount || 0) - (a.viewCount || 0))
          .slice(0, 10);

        if (sortedUrls.length === 0) {
          popularUrlsList.innerHTML = '<p>No URL views recorded yet.</p>';
        } else {
          popularUrlsList.innerHTML = '';
          sortedUrls.forEach(sub => {
            const div = document.createElement('div');
            div.className = 'url-item';
            div.innerHTML = `
              <span class="url-title">${sub.title}</span>
              <span class="url-views">${sub.viewCount} views</span>
            `;
            popularUrlsList.appendChild(div);
          });
        }
      }
    }

    // Create Views Over Time Chart
    function createViewsChart(visits) {
      const ctx = document.getElementById('viewsChart').getContext('2d');
      let chart = null;

      function updateChart(range) {
        const now = new Date();
        let filteredVisits = visits;
        
        if (range !== 'all') {
          const hours = {
            '24h': 24,
            '7d': 7 * 24,
            '30d': 30 * 24,
            '3m': 90 * 24,
            '6m': 180 * 24,
            '12m': 365 * 24
          }[range];
          
          const cutoff = new Date(now.getTime() - hours * 60 * 60 * 1000);
          filteredVisits = visits.filter(v => new Date(v.timestamp) >= cutoff);
        }

        // Group by time period
        const grouped = {};
        filteredVisits.forEach(visit => {
          const date = new Date(visit.timestamp);
          let key;
          
          if (range === '24h') {
            key = `${date.getHours()}:00`;
          } else {
            key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
          }
          
          grouped[key] = (grouped[key] || 0) + 1;
        });

        // Sort keys
        const sortedKeys = Object.keys(grouped).sort();
        const data = sortedKeys.map(key => grouped[key]);

        // Destroy previous chart
        if (chart) {
          chart.destroy();
        }

        // Create new chart
        chart = new Chart(ctx, {
          type: 'line',
           {
            labels: sortedKeys,
            datasets: [{
              label: 'Pageviews',
              data: data,
              borderColor: '#d40000',
              backgroundColor: 'rgba(212, 0, 0, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              x: {
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#fff'
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                ticks: {
                  color: '#fff'
                }
              }
            }
          }
        });
      }

      // Set up filter buttons
      document.querySelectorAll('.time-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          updateChart(this.getAttribute('data-range'));
        });
      });

      // Initialize with 24h
      updateChart('24h');
    }

    // Create Referrer Chart
    function createReferrerChart(visits) {
      const ctx = document.getElementById('referrerChart').getContext('2d');
      const referrerData = {};
      visits.forEach(v => {
        const ref = v.referrer === '' ? 'Direct' : new URL(v.referrer).hostname;
        referrerData[ref] = (referrerData[ref] || 0) + 1;
      });
      
      new Chart(ctx, {
        type: 'bar',
         {
          labels: Object.keys(referrerData).slice(0, 5),
          datasets: [{
             Object.values(referrerData).slice(0, 5),
            backgroundColor: '#d40000'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#fff'
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#fff'
              }
            }
          }
        }
      });
    }

    // Create Browser Chart
    function createBrowserChart(visits) {
      const ctx = document.getElementById('browserChart').getContext('2d');
      const browserData = {};
      visits.forEach(v => {
        browserData[v.browser] = (browserData[v.browser] || 0) + 1;
      });
      
      new Chart(ctx, {
        type: 'doughnut',
         {
          labels: Object.keys(browserData),
          datasets: [{
             Object.values(browserData),
            backgroundColor: ['#d40000', '#006400', '#0000ff', '#ffa500', '#800080']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#fff'
              }
            }
          }
        }
      });
    }

    // Create OS Chart
    function createOSChart(visits) {
      const ctx = document.getElementById('osChart').getContext('2d');
      
      // OS detection
      function getOS(userAgent) {
        if (/Windows/i.test(userAgent)) return 'Windows';
        if (/Mac/i.test(userAgent)) return 'MacOS';
        if (/Linux/i.test(userAgent)) return 'Linux';
        if (/Android/i.test(userAgent)) return 'Android';
        if (/iPhone|iPad|iPod/i.test(userAgent)) return 'iOS';
        return 'Other';
      }

      const osData = {};
      visits.forEach(v => {
        const os = getOS(v.userAgent);
        osData[os] = (osData[os] || 0) + 1;
      });
      
      new Chart(ctx, {
        type: 'pie',
         {
          labels: Object.keys(osData),
          datasets: [{
             Object.values(osData),
            backgroundColor: ['#d40000', '#006400', '#0000ff', '#ffa500', '#800080', '#ff00ff']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#fff'
              }
            }
          }
        }
      });
    }

    // Create Country Chart
    function createCountryChart(visits) {
      const ctx = document.getElementById('countryChart').getContext('2d');
      const countryData = {};
      visits.forEach(v => {
        countryData[v.country] = (countryData[v.country] || 0) + 1;
      });
      
      new Chart(ctx, {
        type: 'bar',
         {
          labels: Object.keys(countryData).slice(0, 5),
          datasets: [{
             Object.values(countryData).slice(0, 5),
            backgroundColor: '#006400'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#fff'
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#fff'
              }
            }
          }
        }
      });
    }

    // Initialize
    checkAdminAccess();
  </script>
</body>
</html>
