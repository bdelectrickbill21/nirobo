<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nirobo ‚Äî Your URL Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #004d00, #006400);
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 2px solid #d40000;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.2rem;
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: rgba(0, 0, 0, 0.3);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid rgba(212, 0, 0, 0.3);
    }

    .stat-card h2 {
      color: #ffcccc;
      margin-bottom: 20px;
      font-size: 1.4rem;
      border-bottom: 1px solid #d40000;
      padding-bottom: 10px;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ff9999;
      margin: 15px 0;
    }

    .chart-container {
      height: 300px;
      margin: 20px 0;
    }

    .time-filter-btn {
      background: #006400;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }

    .time-filter-btn:hover {
      background: #008000;
    }

    .time-filter-btn.active {
      background: #d40000;
      color: white;
    }

    .url-list {
      background: rgba(0, 0, 0, 0.3);
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 40px;
      border: 1px solid rgba(212, 0, 0, 0.3);
    }

    .url-list h2 {
      color: #ffcccc;
      margin-bottom: 20px;
      font-size: 1.4rem;
      border-bottom: 1px solid #d40000;
      padding-bottom: 10px;
    }

    .url-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .url-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #ff9999;
    }

    footer {
      background-color: #1a1a1a;
      color: #ccc;
      padding: 20px;
      text-align: center;
      font-size: 0.9rem;
      border-top: 1px solid #333;
      margin-top: 40px;
    }

    footer a {
      color: #ff9999;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä YOUR URL ANALYTICS</h1>
      <p>‚ÄúYour audience speaks through data ‚Äî listen to what they‚Äôre telling you.‚Äù</p>
    </header>

    <div id="userStatsContent">
      <p>Loading your analytics...</p>
    </div>

    <footer>
      Made in Bangladesh üáßüá© | Curated by Nirobo<br>
      <a href="dashboard.html">‚Üê Back to Dashboard</a>
    </footer>
  </div>

<script>
try {
  // ... all your existing code ...
} catch (e) {
  console.error('Error loading analytics:', e);
  document.getElementById('userStatsContent').innerHTML = `
    <div style="text-align: center; color: #ff9999; padding: 50px;">
      <h3>‚ùå Error Loading Analytics</h3>
      <p>Please refresh the page or contact support.</p>
    </div>
  `;
}

// Check if user is logged in
const currentUser = JSON.parse(localStorage.getItem('niroboCurrentUser') || 'null');
if (!currentUser) {
  alert('Please log in first.');
  window.location.href = 'signup.html';
}

// Load user's submissions and their analytics
function loadUserStats() {
  try {
    const allSubmissions = JSON.parse(localStorage.getItem('niroboAllSubmissions') || '[]');
    const userSubmissions = allSubmissions.filter(sub => sub.userId === currentUser.id);
    
    const visits = JSON.parse(localStorage.getItem('niroboVisits') || '[]');
    
    const container = document.getElementById('userStatsContent');
    
    if (userSubmissions.length === 0) {
      container.innerHTML = '<p>You haven\'t submitted any URLs yet.</p>';
      return;
    }

    // Calculate total views for user's URLs
    let totalViews = 0;
    userSubmissions.forEach(sub => {
      totalViews += sub.viewCount || 0;
    });

    let html = `
      <div class="stats-grid">
        <div class="stat-card">
          <h2>üìà Total Views</h2>
          <div class="stat-number">${totalViews}</div>
          <p>Across all your URLs</p>
        </div>
      </div>
      
      <!-- Time Filter Buttons -->
      <div style="text-align: center; margin: 20px 0;">
        <button class="time-filter-btn active" data-range="24h">Last 24 Hours</button>
        <button class="time-filter-btn" data-range="7d">Last 7 Days</button>
        <button class="time-filter-btn" data-range="30d">Last 30 Days</button>
        <button class="time-filter-btn" data-range="3m">Last 3 Months</button>
        <button class="time-filter-btn" data-range="6m">Last 6 Months</button>
        <button class="time-filter-btn" data-range="12m">Last 12 Months</button>
        <button class="time-filter-btn" data-range="all">Everything</button>
      </div>

      <!-- Views Over Time Chart -->
      <div class="stat-card">
        <h2>üìà Views Over Time</h2>
        <div class="chart-container">
          <canvas id="viewsChart"></canvas>
        </div>
      </div>
      
      <div class="url-list">
        <h2>üöÄ Your Submitted URLs</h2>
    `;

    userSubmissions.forEach(sub => {
      // Get views for this specific URL
      const urlViews = sub.viewCount || 0;
      
      // Get country stats for visits to search results that matched this URL
      const countryStats = {};
      const browserStats = {};
      const osStats = {};
      
      visits.forEach(visit => {
        if (visit.url.includes('search.html?q=')) {
          const url = new URL(visit.url);
          const q = url.searchParams.get('q');
          if (q && (sub.title.toLowerCase().includes(q) || 
                   sub.description.toLowerCase().includes(q) ||
                   (sub.tags && sub.tags.some(tag => tag.toLowerCase().includes(q))))) {
            countryStats[visit.country] = (countryStats[visit.country] || 0) + 1;
            browserStats[visit.browser] = (browserStats[visit.browser] || 0) + 1;
            
            // OS detection
            const os = getOS(visit.userAgent);
            osStats[os] = (osStats[os] || 0) + 1;
          }
        }
      });

      html += `
        <div class="url-item">
          <div class="url-title">${sub.title}</div>
          <p><strong>URL:</strong> ${sub.url}</p>
          <p><strong>Views:</strong> ${urlViews}</p>
          <p><strong>Status:</strong> <span style="color: ${
            sub.status === 'approved' ? '#00aa00' : 
            sub.status === 'rejected' ? '#d40000' : '#ff9900'
          }">${sub.status.toUpperCase()}</span></p>
      `;

      if (Object.keys(countryStats).length > 0) {
        html += `<h4>üåç Top Countries</h4><div class="chart" id="countryChart-${sub.id}"></div>`;
      }
      
      if (Object.keys(browserStats).length > 0) {
        html += `<h4>üíª Top Browsers</h4><div class="chart" id="browserChart-${sub.id}"></div>`;
      }
      
      if (Object.keys(osStats).length > 0) {
        html += `<h4>üì± Top Operating Systems</h4><div class="chart" id="osChart-${sub.id}"></div>`;
      }
      
      html += `</div>`;
    });

    html += `</div>`;
    container.innerHTML = html;

    // Create time-based chart
    createViewsChart(userSubmissions, visits);
    
    // Create charts for each URL
    userSubmissions.forEach(sub => {
      const countryStats = {};
      const browserStats = {};
      const osStats = {};
      
      visits.forEach(visit => {
        if (visit.url.includes('search.html?q=')) {
          const url = new URL(visit.url);
          const q = url.searchParams.get('q');
          if (q && (sub.title.toLowerCase().includes(q) || 
                   sub.description.toLowerCase().includes(q) ||
                   (sub.tags && sub.tags.some(tag => tag.toLowerCase().includes(q))))) {
            countryStats[visit.country] = (countryStats[visit.country] || 0) + 1;
            browserStats[visit.browser] = (browserStats[visit.browser] || 0) + 1;
            const os = getOS(visit.userAgent);
            osStats[os] = (osStats[os] || 0) + 1;
          }
        }
      });
      
      if (Object.keys(countryStats).length > 0) {
        createCountryChart(`countryChart-${sub.id}`, countryStats);
      }
      
      if (Object.keys(browserStats).length > 0) {
        createBrowserChart(`browserChart-${sub.id}`, browserStats);
      }
      
      if (Object.keys(osStats).length > 0) {
        createOSChart(`osChart-${sub.id}`, osStats);
      }
    });
  } catch (e) {
    console.error('Error loading analytics:', e);
    document.getElementById('userStatsContent').innerHTML = `
      <div style="text-align: center; color: #ff9999; padding: 50px;">
        <h3>‚ùå Error Loading Analytics</h3>
        <p>Please refresh the page or contact support.</p>
      </div>
    `;
  }
}

// Create Views Over Time Chart
function createViewsChart(userSubmissions, allVisits) {
  const ctx = document.getElementById('viewsChart').getContext('2d');
  let chart = null;

  function updateChart(range) {
    const now = new Date();
    let filteredVisits = [];
    
    // Get all visits that matched any of the user's URLs
    allVisits.forEach(visit => {
      if (visit.url.includes('search.html?q=')) {
        const url = new URL(visit.url);
        const q = url.searchParams.get('q');
        if (q) {
          // Check if this search matched any of the user's URLs
          const matched = userSubmissions.some(sub => 
            sub.title.toLowerCase().includes(q) || 
            sub.description.toLowerCase().includes(q) ||
            (sub.tags && sub.tags.some(tag => tag.toLowerCase().includes(q)))
          );
          if (matched) {
            filteredVisits.push(visit);
          }
        }
      }
    });
    
    // Filter by time range
    if (range !== 'all') {
      const hours = {
        '24h': 24,
        '7d': 7 * 24,
        '30d': 30 * 24,
        '3m': 90 * 24,
        '6m': 180 * 24,
        '12m': 365 * 24
      }[range];
      
      const cutoff = new Date(now.getTime() - hours * 60 * 60 * 1000);
      filteredVisits = filteredVisits.filter(v => new Date(v.timestamp) >= cutoff);
    }

    // Group by time period
    const grouped = {};
    filteredVisits.forEach(visit => {
      const date = new Date(visit.timestamp);
      let key;
      
      if (range === '24h') {
        key = `${date.getHours()}:00`;
      } else {
        key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      }
      
      grouped[key] = (grouped[key] || 0) + 1;
    });

    // Sort keys
    const sortedKeys = Object.keys(grouped).sort();
    const data = sortedKeys.map(key => grouped[key]);

    // Destroy previous chart
    if (chart) {
      chart.destroy();
    }

    // Create new chart
    chart = new Chart(ctx, {
      type: 'line',
       {
        labels: sortedKeys,
        datasets: [{
          label: 'Views',
           data,
          borderColor: '#d40000',
          backgroundColor: 'rgba(212, 0, 0, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: '#fff'
            }
          },
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: {
              color: '#fff'
            }
          }
        }
      }
    });
  }

  // Set up filter buttons
  document.querySelectorAll('.time-filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.time-filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      updateChart(this.getAttribute('data-range'));
    });
  });

  // Initialize with 24h
  updateChart('24h');
}

// Create Country Chart
function createCountryChart(containerId, data) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 5);
  const maxCount = sorted.length > 0 ? sorted[0][1] : 1;

  sorted.forEach(([label, count]) => {
    const item = document.createElement('div');
    item.className = 'chart-item';
    const percentage = (count / maxCount) * 100;
    item.innerHTML = `
      <span>${label}</span>
      <div style="display: flex; align-items: center; width: 100%;">
        <span style="width: 60px; text-align: right; margin-right: 10px;">${count}</span>
        <div class="chart-bar" style="width: ${percentage}%;"></div>
      </div>
    `;
    container.appendChild(item);
  });
}

// Create Browser Chart
function createBrowserChart(containerId, data) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 5);
  const maxCount = sorted.length > 0 ? sorted[0][1] : 1;

  sorted.forEach(([label, count]) => {
    const item = document.createElement('div');
    item.className = 'chart-item';
    const percentage = (count / maxCount) * 100;
    item.innerHTML = `
      <span>${label}</span>
      <div style="display: flex; align-items: center; width: 100%;">
        <span style="width: 60px; text-align: right; margin-right: 10px;">${count}</span>
        <div class="chart-bar" style="width: ${percentage}%;"></div>
      </div>
    `;
    container.appendChild(item);
  });
}

// Create OS Chart
function createOSChart(containerId, data) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  
  const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 5);
  const maxCount = sorted.length > 0 ? sorted[0][1] : 1;

  sorted.forEach(([label, count]) => {
    const item = document.createElement('div');
    item.className = 'chart-item';
    const percentage = (count / maxCount) * 100;
    item.innerHTML = `
      <span>${label}</span>
      <div style="display: flex; align-items: center; width: 100%;">
        <span style="width: 60px; text-align: right; margin-right: 10px;">${count}</span>
        <div class="chart-bar" style="width: ${percentage}%;"></div>
      </div>
    `;
    container.appendChild(item);
  });
}

// OS detection
function getOS(userAgent) {
  if (/Windows/i.test(userAgent)) return 'Windows';
  if (/Mac/i.test(userAgent)) return 'MacOS';
  if (/Linux/i.test(userAgent)) return 'Linux';
  if (/Android/i.test(userAgent)) return 'Android';
  if (/iPhone|iPad|iPod/i.test(userAgent)) return 'iOS';
  return 'Other';
}

// Initialize
loadUserStats();
</script>
</body>
</html>
