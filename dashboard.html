<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nirobo Admin — Command Center</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-dark: #004d00;
      --primary: #006400;
      --primary-light: #008000;
      --accent: #d40000;
      --accent-hover: #ff0000;
      --background: #0a1f0a;
      --card-bg: #1a1a1a;
      --text: #f5f5f5;
      --text-secondary: #cccccc;
      --border: #333333;
      --success: #00aa00;
      --warning: #ff9900;
      --danger: #d40000;
      --info: #0066cc;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--background), var(--primary-dark));
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 30px 0;
      border-bottom: 2px solid var(--accent);
      margin-bottom: 30px;
      position: relative;
    }

    header h1 {
      color: var(--accent);
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    header h1 span {
      color: var(--text);
    }

    header p {
      font-style: italic;
      color: #ffcccc;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    nav a {
      color: var(--text-secondary);
      text-decoration: none;
      padding: 10px 20px;
      border-radius: 25px;
      background: rgba(0, 100, 0, 0.3);
      transition: all 0.3s ease;
    }

    nav a:hover, nav a.active {
      background: var(--accent);
      color: white;
    }

    .section {
      background: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 1px solid rgba(212, 0, 0, 0.3);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .section h2 {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      border-left: 4px solid var(--accent);
    }

    .card h3 {
      color: var(--accent);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      color: var(--text);
      font-size: 16px;
    }

    button {
      padding: 12px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    button:hover {
      background: var(--accent-hover);
    }

    .btn-secondary { background: var(--info); }
    .btn-secondary:hover { background: #0088ff; }
    .btn-warning { background: var(--warning); }
    .btn-warning:hover { background: #ffcc00; }
    .btn-danger { background: var(--danger); }
    .btn-danger:hover { background: #ff3333; }
    .btn-success { background: var(--success); }
    .btn-success:hover { background: #00cc00; }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .status-badge.approved { background: rgba(0, 170, 0, 0.3); color: var(--success); }
    .status-badge.rejected { background: rgba(212, 0, 0, 0.3); color: var(--danger); }
    .status-badge.pending { background: rgba(255, 153, 0, 0.3); color: var(--warning); }
    .status-badge.perm_ban { background: rgba(136, 0, 0, 0.5); color: #ff9999; }
    .status-badge.temp_ban { background: rgba(255, 153, 0, 0.5); color: #ffcc00; }
    .status-badge.active { background: rgba(0, 170, 0, 0.3); color: var(--success); }

    .item-list {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .item-list::-webkit-scrollbar {
      width: 8px;
    }

    .item-list::-webkit-scrollbar-track {
      background: var(--card-bg);
    }

    .item-list::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }

    .list-item {
      background: rgba(255, 255, 255, 0.03);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid var(--border);
    }

    .list-item.approved { border-left-color: var(--success); }
    .list-item.rejected { border-left-color: var(--danger); }
    .list-item.pending { border-left-color: var(--warning); }
    .list-item.perm_ban { border-left-color: #880000; }
    .list-item.temp_ban { border-left-color: var(--warning); }

    .list-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .list-item-title {
      font-weight: bold;
      font-size: 1.1rem;
    }

    .list-item-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 5px 0;
    }

    .list-item-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed var(--border);
    }

    .list-item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin: 10px 0;
    }

    .tag {
      background: rgba(212, 0, 0, 0.2);
      color: #ff9999;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    .admin-message {
      background: rgba(0, 100, 200, 0.2);
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      font-style: italic;
      font-size: 0.9rem;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { background: linear-gradient(45deg, var(--success), #00cc00); }
    .notification.error { background: linear-gradient(45deg, var(--danger), #ff3333); }
    .notification.warning { background: linear-gradient(45deg, var(--warning), #ffcc00); }
    .notification.info { background: linear-gradient(45deg, var(--info), #0088ff); }

    footer {
      text-align: center;
      padding: 30px;
      color: var(--text-secondary);
      font-size: 0.9rem;
      border-top: 1px solid var(--border);
      margin-top: 50px;
    }

    footer a {
      color: #ff9999;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      nav {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><span>NIROBO</span> ADMIN COMMAND CENTER</h1>
      <p>“With great power comes the responsibility to curate truth.”</p>
    </header>

    <nav>
      <a href="#" class="active" data-view="dashboard"> <i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="#" data-view="account"> <i class="fas fa-user-cog"></i> My Account</a>
      <a href="#" data-view="submissions"> <i class="fas fa-list"></i> My Submissions</a>
      <a href="#" data-view="admin"> <i class="fas fa-users-cog"></i> Admin Controls</a>
      <a href="/"><i class="fas fa-arrow-left"></i> Back to Nirobo</a>
    </nav>

    <!-- Dashboard View -->
    <div class="view active" id="dashboardView">
      <div class="section">
        <h2><i class="fas fa-chart-line"></i> System Overview</h2>
        
        <div class="stats-grid">
          <div class="stat-card">
            <i class="fas fa-users fa-2x"></i>
            <div class="stat-value" id="totalUsersStat">0</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-globe fa-2x"></i>
            <div class="stat-value" id="totalSubmissionsStat">0</div>
            <div class="stat-label">Total Submissions</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-check-circle fa-2x"></i>
            <div class="stat-value" id="approvedSubmissionsStat">0</div>
            <div class="stat-label">Approved</div>
          </div>
          <div class="stat-card">
            <i class="fas fa-clock fa-2x"></i>
            <div class="stat-value" id="pendingSubmissionsStat">0</div>
            <div class="stat-label">Pending</div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <h3><i class="fas fa-user"></i> Welcome, Administrator</h3>
            <p>You have full control over the Nirobo system.</p>
            <p><strong>Email:</strong> <span id="adminEmailDisplay">Loading...</span></p>
            <button id="logoutBtn" class="btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</button>
          </div>

          <div class="card">
            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            <button id="viewUsersBtn" class="btn-secondary" style="width: 100%; margin-bottom: 10px;"><i class="fas fa-users"></i> Manage Users</button>
            <button id="viewAllSubmissionsBtn" class="btn-secondary" style="width: 100%;"><i class="fas fa-list"></i> Review All Submissions</button>
          </div>
        </div>
      </div>
    </div>

    <!-- My Account View -->
    <div class="view" id="accountView" style="display: none;">
      <div class="section">
        <h2><i class="fas fa-user-circle"></i> My Account</h2>
        <div class="grid">
          <div class="card">
            <h3><i class="fas fa-info-circle"></i> Account Details</h3>
            <p><strong>Email:</strong> <span id="myAccountEmail">Loading...</span></p>
            <p><strong>Account Created:</strong> <span id="myAccountCreated">Loading...</span></p>
            <p><strong>Status:</strong> <span class="status-badge active">Active</span></p>
          </div>
          
          <div class="card">
            <h3><i class="fas fa-shield-alt"></i> Security</h3>
            <button id="changePasswordBtn" class="btn-warning" style="width: 100%; margin-bottom: 10px;"><i class="fas fa-key"></i> Change Password</button>
            <button id="deleteMyAccountBtn" class="btn-danger" style="width: 100%;"><i class="fas fa-trash"></i> Delete My Account</button>
          </div>
        </div>
      </div>
    </div>

    <!-- My Submissions View -->
    <div class="view" id="submissionsView" style="display: none;">
      <div class="section">
        <h2><i class="fas fa-list"></i> My Submissions</h2>
        <div class="form-group">
          <label for="mySubmissionsFilter">Filter by Status:</label>
          <select id="mySubmissionsFilter">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="item-list" id="mySubmissionsList">
          <p>Loading your submissions...</p>
        </div>
      </div>
    </div>

    <!-- Admin Controls View -->
    <div class="view" id="adminView" style="display: none;">
      <div class="section">
        <h2><i class="fas fa-users-cog"></i> Admin Controls</h2>
        
        <div class="grid">
          <div class="card">
            <h3><i class="fas fa-users"></i> Manage Users</h3>
            <div class="form-group">
              <label for="usersFilter">Filter Users:</label>
              <select id="usersFilter">
                <option value="all">All Users</option>
                <option value="active">Active</option>
                <option value="banned">Banned</option>
              </select>
            </div>
            <div class="item-list" id="usersList">
              <p>Loading users...</p>
            </div>
          </div>

          <div class="card">
            <h3><i class="fas fa-globe"></i> Review Submissions</h3>
            <div class="form-group">
              <label for="submissionsFilter">Filter Submissions:</label>
              <select id="submissionsFilter">
                <option value="all">All Submissions</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div class="item-list" id="allSubmissionsList">
              <p>Loading submissions...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>Made in Bangladesh 🇧🇩 | Curated by Nirobo</p>
      <p>Honoring the Language Movement and the Silent Legacy of Justice</p>
      <p>Crafted by KH. AL SHAIF — for truth, clarity, and cultural dignity</p>
      <p><a href="/"><i class="fas fa-arrow-left"></i> Back to Nirobo</a></p>
    </footer>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // --- STATE & CONFIG ---
    const VIEWS = ['dashboard', 'account', 'submissions', 'admin'];
    let currentUser = null;
    let allUsers = [];
    let allSubmissions = [];
    let punishments = {};

    // --- DOM ELEMENTS ---
    const viewElements = {
      dashboard: document.getElementById('dashboardView'),
      account: document.getElementById('accountView'),
      submissions: document.getElementById('submissionsView'),
      admin: document.getElementById('adminView')
    };
    const navLinks = document.querySelectorAll('nav a[data-view]');
    const notification = document.getElementById('notification');
    const logoutBtn = document.getElementById('logoutBtn');

    // --- UTILITY FUNCTIONS ---
    function loadData(key, defaultValue = []) {
      try {
        return JSON.parse(localStorage.getItem(key) || JSON.stringify(defaultValue));
      } catch (e) {
        console.error(`Error loading ${key}:`, e);
        return defaultValue;
      }
    }

    function saveData(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
      } catch (e) {
        console.error(`Error saving ${key}:`, e);
        showNotification('Failed to save data.', 'error');
      }
    }

    function hashPassword(password) {
      return btoa(password); // Simple demo hash
    }

    function formatDate(isoString) {
        if (!isoString) return 'Unknown';
        const date = new Date(isoString);
        // Ensure it's displayed in local (BD) time
        return date.toLocaleString('en-GB', {
            timeZone: 'Asia/Dhaka',
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }


    function showNotification(message, type = 'info', duration = 3000) {
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    // --- AUTHENTICATION ---
    function checkAuth() {
      const user = loadData('niroboCurrentUser', null);
      if (!user) {
        window.location.href = 'signup.html';
        return null;
      }
      // Simple check for admin role (you can define this however you want)
      // For now, assume the first user or a specific email is admin
      // A more robust system would have a role field in the user object
      const users = loadData('niroboUsers', []);
      const isAdmin = users.length > 0 && users[0].id === user.id; // First user is admin
      // OR: const isAdmin = user.email === "admin@nirobo.net"; 
      
      if (!isAdmin) {
         showNotification('Access denied. Admin privileges required.', 'error');
         setTimeout(() => {
            localStorage.removeItem('niroboCurrentUser');
            window.location.href = 'signup.html';
         }, 2000);
         return null;
      }
      return user;
    }

    function logout() {
      localStorage.removeItem('niroboCurrentUser');
      showNotification('Logged out successfully.', 'success');
      setTimeout(() => {
        window.location.href = 'signup.html';
      }, 1000);
    }

    // --- VIEW MANAGEMENT ---
    function switchView(viewName) {
      VIEWS.forEach(view => {
        viewElements[view].style.display = 'none';
        document.querySelector(`nav a[data-view="${view}"]`).classList.remove('active');
      });
      viewElements[viewName].style.display = 'block';
      document.querySelector(`nav a[data-view="${viewName}"]`).classList.add('active');

      // Load data for the view
      switch(viewName) {
        case 'dashboard':
          loadDashboardData();
          break;
        case 'account':
          loadAccountData();
          break;
        case 'submissions':
          loadMySubmissions();
          break;
        case 'admin':
          loadAdminData();
          break;
      }
    }

    // --- DASHBOARD LOGIC ---
    function loadDashboardData() {
      allUsers = loadData('niroboUsers', []);
      allSubmissions = loadData('niroboAllSubmissions', []);
      punishments = loadData('niroboPunishments', {});
      
      document.getElementById('adminEmailDisplay').textContent = currentUser.email;
      
      document.getElementById('totalUsersStat').textContent = allUsers.length;
      document.getElementById('totalSubmissionsStat').textContent = allSubmissions.length;
      document.getElementById('approvedSubmissionsStat').textContent = allSubmissions.filter(s => s.status === 'approved').length;
      document.getElementById('pendingSubmissionsStat').textContent = allSubmissions.filter(s => s.status === 'pending').length;
    }

    // --- ACCOUNT LOGIC ---
    function loadAccountData() {
      document.getElementById('myAccountEmail').textContent = currentUser.email;
      document.getElementById('myAccountCreated').textContent = formatDate(currentUser.createdAt);
    }

    // --- MY SUBMISSIONS LOGIC ---
    function loadMySubmissions() {
      const filter = document.getElementById('mySubmissionsFilter').value;
      let filteredSubs = allSubmissions.filter(s => s.userId === currentUser.id);
      
      if (filter !== 'all') {
        filteredSubs = filteredSubs.filter(s => s.status === filter);
      }

      const container = document.getElementById('mySubmissionsList');
      container.innerHTML = '';
      
      if (filteredSubs.length === 0) {
        container.innerHTML = '<p>No submissions found.</p>';
        return;
      }

      filteredSubs.forEach(sub => {
        const itemEl = document.createElement('div');
        itemEl.className = `list-item ${sub.status}`;
        itemEl.innerHTML = `
          <div class="list-item-header">
            <div class="list-item-title">${sub.title}</div>
            <span class="status-badge ${sub.status}">${sub.status.toUpperCase()}</span>
          </div>
          <div class="list-item-meta"><i class="fas fa-link"></i> <a href="${sub.url}" target="_blank">${sub.url}</a></div>
          <div class="list-item-meta"><i class="fas fa-calendar"></i> Submitted: ${formatDate(sub.submittedAt)}</div>
          <div class="list-item-meta"><i class="fas fa-eye"></i> Views: ${sub.viewCount || 0}</div>
          ${sub.adminMessage ? `<div class="admin-message"><i class="fas fa-comment"></i> Admin Message: ${sub.adminMessage}</div>` : ''}
          <div class="list-item-tags">
            ${(Array.isArray(sub.tags) ? sub.tags : []).map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
          <div class="list-item-actions">
            <button class="btn-danger" onclick="deleteMySubmission('${sub.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        container.appendChild(itemEl);
      });
    }

    window.deleteMySubmission = function(subId) {
      if (!confirm('Are you sure you want to delete this submission?')) return;
      allSubmissions = allSubmissions.filter(s => s.id !== subId);
      saveData('niroboAllSubmissions', allSubmissions);
      showNotification('Submission deleted.', 'success');
      loadMySubmissions(); // Refresh list
    };

    document.getElementById('mySubmissionsFilter').addEventListener('change', loadMySubmissions);

    // --- ADMIN CONTROLS LOGIC ---
    function loadAdminData() {
      loadUsersList();
      loadAllSubmissionsList();
    }

    function loadUsersList() {
      const filter = document.getElementById('usersFilter').value;
      let filteredUsers = [...allUsers];

      if (filter === 'active') {
        filteredUsers = filteredUsers.filter(u => {
          const punishment = punishments[u.id];
          return !punishment || (punishment.banStatus !== 'perm_ban' && 
                                  !(punishment.banStatus === 'temp_ban' && new Date(punishment.banUntil) > new Date()));
        });
      } else if (filter === 'banned') {
        filteredUsers = filteredUsers.filter(u => {
          const punishment = punishments[u.id];
          return punishment && (punishment.banStatus === 'perm_ban' || 
                                (punishment.banStatus === 'temp_ban' && new Date(punishment.banUntil) > new Date()));
        });
      }

      const container = document.getElementById('usersList');
      container.innerHTML = '';
      
      if (filteredUsers.length === 0) {
        container.innerHTML = '<p>No users found.</p>';
        return;
      }

      filteredUsers.forEach(user => {
        const punishment = punishments[user.id];
        let status = 'active';
        let statusText = 'ACTIVE';
        if (punishment) {
          if (punishment.banStatus === 'perm_ban') {
            status = 'perm_ban';
            statusText = 'PERMANENTLY BANNED';
          } else if (punishment.banStatus === 'temp_ban' && new Date(punishment.banUntil) > new Date()) {
            status = 'temp_ban';
            statusText = `TEMP BANNED UNTIL ${formatDate(punishment.banUntil)}`;
          }
        }

        const userSubmissions = allSubmissions.filter(s => s.userId === user.id).length;

        const itemEl = document.createElement('div');
        itemEl.className = `list-item ${status}`;
        itemEl.innerHTML = `
          <div class="list-item-header">
            <div class="list-item-title">${user.email}</div>
            <span class="status-badge ${status}">${statusText}</span>
          </div>
          <div class="list-item-meta"><i class="fas fa-calendar"></i> Joined: ${formatDate(user.createdAt)}</div>
          <div class="list-item-meta"><i class="fas fa-globe"></i> Submissions: ${userSubmissions}</div>
          <div class="list-item-actions">
            ${status === 'active' ? `
              <button class="btn-warning" onclick="banUser('${user.id}', 'temp')"><i class="fas fa-ban"></i> Temp Ban</button>
              <button class="btn-danger" onclick="banUser('${user.id}', 'perm')"><i class="fas fa-ban"></i> Perm Ban</button>
            ` : `
              <button class="btn-success" onclick="unbanUser('${user.id}')"><i class="fas fa-check"></i> Unban</button>
            `}
            <button class="btn-danger" onclick="deleteUser('${user.id}')"><i class="fas fa-user-slash"></i> Delete</button>
          </div>
        `;
        container.appendChild(itemEl);
      });
    }

    function loadAllSubmissionsList() {
      const filter = document.getElementById('submissionsFilter').value;
      let filteredSubs = [...allSubmissions];

      if (filter !== 'all') {
        filteredSubs = filteredSubs.filter(s => s.status === filter);
      }

      // Sort by newest first
      filteredSubs.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));

      const container = document.getElementById('allSubmissionsList');
      container.innerHTML = '';
      
      if (filteredSubs.length === 0) {
        container.innerHTML = '<p>No submissions found.</p>';
        return;
      }

      filteredSubs.forEach(sub => {
        const submittingUser = allUsers.find(u => u.id === sub.userId) || { email: 'Unknown User' };
        const itemEl = document.createElement('div');
        itemEl.className = `list-item ${sub.status}`;
        itemEl.innerHTML = `
          <div class="list-item-header">
            <div class="list-item-title">${sub.title}</div>
            <span class="status-badge ${sub.status}">${sub.status.toUpperCase()}</span>
          </div>
          <div class="list-item-meta"><i class="fas fa-user"></i> Submitted by: ${submittingUser.email}</div>
          <div class="list-item-meta"><i class="fas fa-link"></i> <a href="${sub.url}" target="_blank">${sub.url}</a></div>
          <div class="list-item-meta"><i class="fas fa-calendar"></i> Submitted: ${formatDate(sub.submittedAt)}</div>
          <div class="list-item-meta"><i class="fas fa-eye"></i> Views: ${sub.viewCount || 0}</div>
          <div class="list-item-tags">
            ${(Array.isArray(sub.tags) ? sub.tags : []).map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>
          ${sub.adminMessage ? `<div class="admin-message"><i class="fas fa-comment"></i> Current Message: ${sub.adminMessage}</div>` : ''}
          <div class="list-item-actions">
            ${sub.status !== 'approved' ? `<button class="btn-success" onclick="moderateSubmission('${sub.id}', 'approve')"><i class="fas fa-check"></i> Approve</button>` : ''}
            ${sub.status !== 'rejected' ? `<button class="btn-danger" onclick="moderateSubmission('${sub.id}', 'reject')"><i class="fas fa-times"></i> Reject</button>` : ''}
            <button class="btn-warning" onclick="promptAdminMessage('${sub.id}')"><i class="fas fa-comment-dots"></i> Message</button>
            <button class="btn-danger" onclick="deleteAnySubmission('${sub.id}')"><i class="fas fa-trash"></i> Delete</button>
          </div>
        `;
        container.appendChild(itemEl);
      });
    }

    window.promptAdminMessage = function(subId) {
        const message = prompt("Enter an admin message for this submission:");
        if (message !== null) { // Allow empty string to clear message
            moderateSubmission(subId, 'message', message);
        }
    };


    window.moderateSubmission = function(subId, action, message = '') {
      const index = allSubmissions.findIndex(s => s.id === subId);
      if (index === -1) return;

      switch(action) {
        case 'approve':
          allSubmissions[index].status = 'approved';
          allSubmissions[index].adminMessage = message || "Your submission has been approved!";
          showNotification('Submission approved.', 'success');
          break;
        case 'reject':
          allSubmissions[index].status = 'rejected';
          allSubmissions[index].adminMessage = message || "Sorry, your submission was not approved.";
          showNotification('Submission rejected.', 'warning');
          break;
        case 'message':
          allSubmissions[index].adminMessage = message;
          showNotification('Admin message updated.', 'info');
          break;
      }
      
      saveData('niroboAllSubmissions', allSubmissions);
      loadAllSubmissionsList(); // Refresh list
    };

    window.banUser = function(userId, banType) {
      const banDays = banType === 'temp' ? parseInt(prompt("Ban for how many days?", "7")) || 7 : 0;
      const banUntil = new Date();
      banUntil.setDate(banUntil.getDate() + banDays);
      
      punishments[userId] = {
        banStatus: banType === 'perm' ? 'perm_ban' : 'temp_ban',
        banUntil: banType === 'temp' ? banUntil.toISOString() : null,
        bannedAt: new Date().toISOString()
      };
      
      saveData('niroboPunishments', punishments);
      showNotification(`User ${banType === 'perm' ? 'permanently' : `temporarily (${banDays} days)`} banned.`, 'warning');
      loadUsersList(); // Refresh list
    };

    window.unbanUser = function(userId) {
      delete punishments[userId];
      saveData('niroboPunishments', punishments);
      showNotification('User unbanned.', 'success');
      loadUsersList(); // Refresh list
    };

    window.deleteUser = function(userId) {
      if (!confirm('This will delete the user account and ALL their submissions. Are you sure?')) return;
      
      // Delete user
      allUsers = allUsers.filter(u => u.id !== userId);
      saveData('niroboUsers', allUsers);
      
      // Delete their submissions
      allSubmissions = allSubmissions.filter(s => s.userId !== userId);
      saveData('niroboAllSubmissions', allSubmissions);
      
      // Remove punishment record
      delete punishments[userId];
      saveData('niroboPunishments', punishments);
      
      showNotification('User and their submissions deleted.', 'success');
      loadAdminData(); // Refresh all admin lists
    };

    window.deleteAnySubmission = function(subId) {
      if (!confirm('Are you sure you want to delete this submission?')) return;
      allSubmissions = allSubmissions.filter(s => s.id !== subId);
      saveData('niroboAllSubmissions', allSubmissions);
      showNotification('Submission deleted.', 'success');
      loadAllSubmissionsList(); // Refresh list
    };

    document.getElementById('usersFilter').addEventListener('change', loadUsersList);
    document.getElementById('submissionsFilter').addEventListener('change', loadAllSubmissionsList);

    // --- EVENT LISTENERS ---
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        switchView(link.dataset.view);
      });
    });

    logoutBtn.addEventListener('click', logout);

    document.getElementById('changePasswordBtn').addEventListener('click', () => {
      const newPassword = prompt("Enter a new password:");
      if (newPassword && newPassword.length >= 6) {
        const users = loadData('niroboUsers', []);
        const index = users.findIndex(u => u.id === currentUser.id);
        if (index !== -1) {
          users[index].password = hashPassword(newPassword);
          saveData('niroboUsers', users);
          
          // Also update currentUser in localStorage if it's the same user
          const currentStoredUser = loadData('niroboCurrentUser', null);
          if (currentStoredUser && currentStoredUser.id === currentUser.id) {
              currentStoredUser.password = users[index].password;
              saveData('niroboCurrentUser', currentStoredUser);
          }
          
          showNotification('Password changed successfully!', 'success');
        }
      } else if (newPassword) {
        showNotification('Password must be at least 6 characters.', 'error');
      }
    });

    document.getElementById('deleteMyAccountBtn').addEventListener('click', () => {
      if (!confirm('This will delete your admin account. This action cannot be undone. Are you sure?')) return;
      
      // This is the admin deleting their own account
      const users = loadData('niroboUsers', []);
      const updatedUsers = users.filter(u => u.id !== currentUser.id);
      saveData('niroboUsers', updatedUsers);
      
      // Also delete their submissions
      const updatedSubmissions = allSubmissions.filter(s => s.userId !== currentUser.id);
      saveData('niroboAllSubmissions', updatedSubmissions);
      
      // Logout
      logout();
    });

    document.getElementById('viewUsersBtn').addEventListener('click', () => switchView('admin'));
    document.getElementById('viewAllSubmissionsBtn').addEventListener('click', () => switchView('admin'));

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
      currentUser = checkAuth();
      if (!currentUser) return;

      // Initial data load
      allUsers = loadData('niroboUsers', []);
      allSubmissions = loadData('niroboAllSubmissions', []);
      punishments = loadData('niroboPunishments', {});

      switchView('dashboard'); // Start on dashboard
      showNotification(`Welcome back, Admin (${currentUser.email})`, 'success', 2000);
    });
  </script>
</body>
</html>
